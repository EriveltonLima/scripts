#!/bin/bash

# DiskView Ultra - Vers√£o Corrigida com Navega√ß√£o Funcional
# Corre√ß√£o dos problemas de navega√ß√£o e entrada autom√°tica
# Vers√£o: 2.1

set -e

# Cores para interface
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
WHITE='\033[1;37m'
GRAY='\033[0;37m'
BOLD='\033[1m'
NC='\033[0m'

# Caracteres especiais
BLOCK_FULL="‚ñà"
BLOCK_EMPTY="‚ñë"
ARROW="‚ñ∫"
BULLET="‚óè"

# Vari√°veis globais
declare -a FILESYSTEMS
declare -a SIZES
declare -a USED
declare -a AVAILABLE
declare -a PERCENTAGES
declare -a MOUNTPOINTS
declare -a TYPES
SELECTED=0
AUTO_REFRESH=false
REFRESH_INTERVAL=3

# Fun√ß√£o para configurar terminal para navega√ß√£o
setup_terminal() {
    # Configurar terminal para capturar teclas especiais
    stty -echo -icanon min 1 time 0
}

# Fun√ß√£o para restaurar terminal
restore_terminal() {
    stty echo icanon
}

# Fun√ß√£o para ler tecla √∫nica
read_key() {
    local key
    IFS= read -r -n1 key 2>/dev/null
    
    # Verificar se √© sequ√™ncia de escape (setas)
    if [[ $key == $'\x1b' ]]; then
        IFS= read -r -n1 key 2>/dev/null
        if [[ $key == '[' ]]; then
            IFS= read -r -n1 key 2>/dev/null
            case $key in
                'A') echo "UP" ;;
                'B') echo "DOWN" ;;
                'C') echo "RIGHT" ;;
                'D') echo "LEFT" ;;
                *) echo "ESC" ;;
            esac
        else
            echo "ESC"
        fi
    else
        case $key in
            '') echo "ENTER" ;;
            ' ') echo "SPACE" ;;
            $'\x7f') echo "BACKSPACE" ;;
            $'\x03') echo "CTRL_C" ;;
            *) echo "$key" ;;
        esac
    fi
}

# Fun√ß√£o para obter dados do df
get_disk_data() {
    FILESYSTEMS=()
    SIZES=()
    USED=()
    AVAILABLE=()
    PERCENTAGES=()
    MOUNTPOINTS=()
    TYPES=()
    
    while IFS= read -r line; do
        [[ -z "$line" || "$line" =~ ^Filesystem ]] && continue
        
        local fields=($line)
        local filesystem="${fields[0]}"
        local fstype="${fields[1]}"
        local size="${fields[2]}"
        local used="${fields[3]}"
        local avail="${fields[4]}"
        local percent="${fields[5]%?}"
        local mountpoint="${fields[6]}"
        
        if [[ ! "$filesystem" =~ ^(tmpfs|udev|devpts|sysfs|proc|cgroup)$ ]] && [[ "$size" != "0" ]]; then
            FILESYSTEMS+=("$filesystem")
            TYPES+=("$fstype")
            SIZES+=("$size")
            USED+=("$used")
            AVAILABLE+=("$avail")
            PERCENTAGES+=("$percent")
            MOUNTPOINTS+=("$mountpoint")
        fi
    done < <(df -hT 2>/dev/null)
}

# Fun√ß√£o para criar barra visual
create_bar() {
    local percentage=$1
    local width=40
    local filled=$((percentage * width / 100))
    local empty=$((width - filled))
    
    local bar=""
    local color=""
    
    if [ $percentage -ge 90 ]; then
        color=$RED
    elif [ $percentage -ge 75 ]; then
        color=$YELLOW
    elif [ $percentage -ge 50 ]; then
        color=$BLUE
    else
        color=$GREEN
    fi
    
    for ((i=0; i<filled; i++)); do
        bar+="${color}${BLOCK_FULL}${NC}"
    done
    
    for ((i=0; i<empty; i++)); do
        bar+="${GRAY}${BLOCK_EMPTY}${NC}"
    done
    
    echo -e "$bar"
}

# Fun√ß√£o para truncar texto
truncate_text() {
    local text="$1"
    local max_length=$2
    
    if [ ${#text} -gt $max_length ]; then
        echo "${text:0:$((max_length-3))}..."
    else
        printf "%-${max_length}s" "$text"
    fi
}

# Fun√ß√£o para desenhar interface principal
draw_interface() {
    clear
    
    echo -e "${WHITE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${WHITE}‚ïë${CYAN}                                    DISKVIEW ULTRA                                                   ${WHITE}‚ïë${NC}"
    echo -e "${WHITE}‚ïë${YELLOW}                          Visualizador Interativo de Espa√ßo em Disco                             ${WHITE}‚ïë${NC}"
    echo -e "${WHITE}‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£${NC}"
    
    if [ ${#FILESYSTEMS[@]} -eq 0 ]; then
        echo -e "${WHITE}‚ïë${NC} ${RED}Nenhum sistema de arquivos encontrado!${NC}"
        echo -e "${WHITE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
        return
    fi
    
    # Status geral
    local total_disks=${#FILESYSTEMS[@]}
    local critical_disks=0
    local warning_disks=0
    local healthy_disks=0
    
    for percent in "${PERCENTAGES[@]}"; do
        if [ $percent -ge 90 ]; then
            critical_disks=$((critical_disks + 1))
        elif [ $percent -ge 75 ]; then
            warning_disks=$((warning_disks + 1))
        else
            healthy_disks=$((healthy_disks + 1))
        fi
    done
    
    echo -e "${WHITE}‚ïë${NC} ${BOLD}Status:${NC} ${GREEN}‚óè${NC} Saud√°veis: ${GREEN}$healthy_disks${NC} | ${YELLOW}‚óè${NC} Aten√ß√£o: ${YELLOW}$warning_disks${NC} | ${RED}‚óè${NC} Cr√≠ticos: ${RED}$critical_disks${NC} | Total: ${CYAN}$total_disks${NC}"
    
    if [ "$AUTO_REFRESH" = true ]; then
        echo -e "${WHITE}‚ïë${NC} ${GREEN}üîÑ Auto-refresh: ATIVO${NC} (${REFRESH_INTERVAL}s) | Atualiza√ß√£o: $(date '+%H:%M:%S')"
    else
        echo -e "${WHITE}‚ïë${NC} ${GRAY}üîÑ Auto-refresh: INATIVO${NC} | √öltima atualiza√ß√£o: $(date '+%H:%M:%S')"
    fi
    
    echo -e "${WHITE}‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£${NC}"
    echo -e "${WHITE}‚ïë${NC} ${BOLD}St${NC} ${BOLD}Sistema de Arquivos (Caminho Completo)${NC}           ${BOLD}Tipo${NC}  ${BOLD}Tamanho${NC}  ${BOLD}Usado${NC}   ${BOLD}Livre${NC}   ${BOLD}Uso%${NC} ${BOLD}Barra Visual${NC}                    ${BOLD}Montagem${NC}"
    echo -e "${WHITE}‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£${NC}"
    
    # Mostrar discos
    for ((i=0; i<${#FILESYSTEMS[@]}; i++)); do
        local filesystem="${FILESYSTEMS[i]}"
        local fstype="${TYPES[i]}"
        local size="${SIZES[i]}"
        local used="${USED[i]}"
        local avail="${AVAILABLE[i]}"
        local percent="${PERCENTAGES[i]}"
        local mountpoint="${MOUNTPOINTS[i]}"
        
        # Status indicator
        local status_color=$GREEN
        if [ $percent -ge 90 ]; then
            status_color=$RED
        elif [ $percent -ge 75 ]; then
            status_color=$YELLOW
        elif [ $percent -ge 50 ]; then
            status_color=$BLUE
        fi
        
        # Formata√ß√£o
        local fs_display=$(truncate_text "$filesystem" 35)
        local type_display=$(printf "%-5s" "${fstype:0:5}")
        local size_f=$(printf "%7s" "$size")
        local used_f=$(printf "%7s" "$used")
        local avail_f=$(printf "%7s" "$avail")
        local percent_f=$(printf "%3s" "$percent")
        local mount_display=$(truncate_text "$mountpoint" 15)
        
        # Barra visual
        local bar=$(create_bar $percent)
        
        # Destacar item selecionado
        local line_color=""
        local marker="  "
        if [ $i -eq $SELECTED ]; then
            line_color=$WHITE
            marker="${CYAN}${ARROW} ${NC}"
        fi
        
        echo -e "${WHITE}‚ïë${line_color}${marker}${status_color}${BULLET}${NC} ${fs_display} ${type_display} ${size_f} ${used_f} ${avail_f} ${status_color}${percent_f}%${NC} ${bar} ${CYAN}${mount_display}${NC}"
    done
    
    echo -e "${WHITE}‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£${NC}"
    echo -e "${WHITE}‚ïë${NC} ${BOLD}Item selecionado:${NC} ${GREEN}${FILESYSTEMS[SELECTED]}${NC} (${YELLOW}${PERCENTAGES[SELECTED]}%${NC} usado)"
    echo -e "${WHITE}‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£${NC}"
    echo -e "${WHITE}‚ïë${NC} ${CYAN}Navega√ß√£o:${NC} [‚Üë‚Üì] ou [j/k] Mover | [Enter] Detalhes | [r] Refresh | [a] Auto | [c] Cache | [q] Sair"
    echo -e "${WHITE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
}

# Fun√ß√£o para mostrar detalhes
show_disk_details() {
    local index=$1
    clear
    
    local filesystem="${FILESYSTEMS[index]}"
    local fstype="${TYPES[index]}"
    local size="${SIZES[index]}"
    local used="${USED[index]}"
    local avail="${AVAILABLE[index]}"
    local percent="${PERCENTAGES[index]}"
    local mountpoint="${MOUNTPOINTS[index]}"
    
    echo -e "${WHITE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${WHITE}‚ïë${CYAN}                                    DETALHES DO DISCO                                               ${WHITE}‚ïë${NC}"
    echo -e "${WHITE}‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£${NC}"
    
    local status_color=$GREEN
    local status_text="SAUD√ÅVEL"
    if [ $percent -ge 95 ]; then
        status_color=$RED
        status_text="CR√çTICO"
    elif [ $percent -ge 85 ]; then
        status_color=$YELLOW
        status_text="ATEN√á√ÉO"
    elif [ $percent -ge 70 ]; then
        status_color=$BLUE
        status_text="MODERADO"
    fi
    
    echo -e "${WHITE}‚ïë${NC} ${BOLD}Status:${NC} ${status_color}${BULLET} ${status_text}${NC}"
    echo -e "${WHITE}‚ïë${NC}"
    echo -e "${WHITE}‚ïë${NC} ${BOLD}üìÅ Sistema de Arquivos:${NC} ${CYAN}$filesystem${NC}"
    echo -e "${WHITE}‚ïë${NC} ${BOLD}üìÇ Ponto de Montagem:${NC}   ${CYAN}$mountpoint${NC}"
    echo -e "${WHITE}‚ïë${NC} ${BOLD}üóÇÔ∏è  Tipo:${NC}               ${YELLOW}$fstype${NC}"
    echo -e "${WHITE}‚ïë${NC} ${BOLD}üíæ Tamanho Total:${NC}       ${YELLOW}$size${NC}"
    echo -e "${WHITE}‚ïë${NC} ${BOLD}üìä Espa√ßo Usado:${NC}        ${RED}$used${NC}"
    echo -e "${WHITE}‚ïë${NC} ${BOLD}üíø Espa√ßo Livre:${NC}        ${GREEN}$avail${NC}"
    echo -e "${WHITE}‚ïë${NC} ${BOLD}üìà Uso:${NC}                 ${status_color}$percent%${NC}"
    echo -e "${WHITE}‚ïë${NC}"
    
    # Barra visual grande
    local big_bar=$(create_bar $percent)
    echo -e "${WHITE}‚ïë${NC} ${BOLD}Visualiza√ß√£o:${NC} $big_bar ${status_color}$percent%${NC}"
    echo -e "${WHITE}‚ïë${NC}"
    
    # Informa√ß√µes adicionais
    local inode_info=$(df -i "$mountpoint" 2>/dev/null | tail -n 1)
    if [ -n "$inode_info" ]; then
        local inode_used=$(echo "$inode_info" | awk '{print $3}')
        local inode_avail=$(echo "$inode_info" | awk '{print $4}')
        local inode_percent=$(echo "$inode_info" | awk '{print $5}' | tr -d '%')
        echo -e "${WHITE}‚ïë${NC} ${BOLD}üîó Inodes:${NC} Usados: ${YELLOW}$inode_used${NC} | Livres: ${GREEN}$inode_avail${NC} | Uso: ${CYAN}$inode_percent%${NC}"
    fi
    
    echo -e "${WHITE}‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£${NC}"
    echo -e "${WHITE}‚ïë${NC} ${CYAN}Comandos:${NC} [b] Voltar | [d] Analisar diret√≥rio | [c] Limpar cache | [q] Sair"
    echo -e "${WHITE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    
    # Loop de comandos nos detalhes
    while true; do
        echo -ne "\n${CYAN}Comando (detalhes): ${NC}"
        local cmd=$(read_key)
        
        case $cmd in
            'b'|'B')
                return
                ;;
            'd'|'D')
                analyze_directory "$mountpoint"
                ;;
            'c'|'C')
                clear_cache
                ;;
            'q'|'Q')
                restore_terminal
                exit 0
                ;;
            'ENTER')
                return
                ;;
        esac
    done
}

# Fun√ß√£o para an√°lise de diret√≥rio
analyze_directory() {
    local path="$1"
    echo -e "\n${YELLOW}üîç Analisando: $path${NC}"
    echo -e "${CYAN}Top 10 maiores diret√≥rios:${NC}\n"
    
    du -h "$path"/* 2>/dev/null | sort -hr | head -10 | while read size dir; do
        echo -e "${GREEN}$size${NC} - ${BLUE}$(basename "$dir")${NC}"
    done
    
    echo -e "\n${CYAN}Pressione qualquer tecla para continuar...${NC}"
    read_key > /dev/null
}

# Fun√ß√£o para limpar cache
clear_cache() {
    echo -e "\n${YELLOW}üßπ Limpando caches...${NC}"
    sync
    echo 1 > /proc/sys/vm/drop_caches 2>/dev/null && echo -e "${GREEN}‚úÖ Cache limpo${NC}" || echo -e "${RED}‚ùå Erro (root necess√°rio)${NC}"
    echo -e "\n${CYAN}Pressione qualquer tecla para continuar...${NC}"
    read_key > /dev/null
}

# Fun√ß√£o de navega√ß√£o principal CORRIGIDA
navigate() {
    setup_terminal
    
    while true; do
        get_disk_data
        draw_interface
        
        if [ ${#FILESYSTEMS[@]} -eq 0 ]; then
            echo -e "\n${CYAN}Pressione qualquer tecla para sair...${NC}"
            read_key > /dev/null
            restore_terminal
            exit 0
        fi
        
        # Aguardar comando
        if [ "$AUTO_REFRESH" = true ]; then
            # Auto-refresh com timeout
            local cmd=""
            for ((i=0; i<REFRESH_INTERVAL; i++)); do
                echo -ne "\r${GRAY}Auto-refresh em $((REFRESH_INTERVAL - i))s... (pressione qualquer tecla)${NC}"
                if timeout 1 bash -c 'read -n 1' 2>/dev/null; then
                    cmd=$(read_key)
                    break
                fi
            done
            echo -ne "\r${NC}"
        else
            echo -ne "\n${CYAN}Comando: ${NC}"
            local cmd=$(read_key)
        fi
        
        # Processar comando
        case $cmd in
            'j'|'J'|'DOWN')
                if [ $SELECTED -lt $((${#FILESYSTEMS[@]} - 1)) ]; then
                    SELECTED=$((SELECTED + 1))
                fi
                ;;
            'k'|'K'|'UP')
                if [ $SELECTED -gt 0 ]; then
                    SELECTED=$((SELECTED - 1))
                fi
                ;;
            'ENTER'|'SPACE')
                show_disk_details $SELECTED
                ;;
            'r'|'R')
                echo -e "\n${GREEN}üîÑ Atualizando...${NC}"
                sleep 1
                ;;
            'a'|'A')
                if [ "$AUTO_REFRESH" = true ]; then
                    AUTO_REFRESH=false
                    echo -e "\n${YELLOW}Auto-refresh DESATIVADO${NC}"
                else
                    AUTO_REFRESH=true
                    echo -e "\n${GREEN}Auto-refresh ATIVADO (${REFRESH_INTERVAL}s)${NC}"
                fi
                sleep 1
                ;;
            'c'|'C')
                clear_cache
                ;;
            'q'|'Q'|'CTRL_C')
                echo -e "\n${GREEN}üëã Saindo...${NC}"
                restore_terminal
                exit 0
                ;;
            'h'|'H'|'?')
                show_help
                ;;
        esac
    done
}

# Fun√ß√£o de ajuda
show_help() {
    clear
    echo -e "${WHITE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${WHITE}‚ïë${CYAN}                                     AJUDA                                                          ${WHITE}‚ïë${NC}"
    echo -e "${WHITE}‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£${NC}"
    echo -e "${WHITE}‚ïë${NC} ${BOLD}Navega√ß√£o Principal:${NC}"
    echo -e "${WHITE}‚ïë${NC}   ${CYAN}‚Üë/k${NC}     - Mover para cima"
    echo -e "${WHITE}‚ïë${NC}   ${CYAN}‚Üì/j${NC}     - Mover para baixo"
    echo -e "${WHITE}‚ïë${NC}   ${CYAN}Enter${NC}   - Ver detalhes do disco"
    echo -e "${WHITE}‚ïë${NC}   ${CYAN}r${NC}       - Atualizar dados"
    echo -e "${WHITE}‚ïë${NC}   ${CYAN}a${NC}       - Auto-refresh on/off"
    echo -e "${WHITE}‚ïë${NC}   ${CYAN}c${NC}       - Limpar cache"
    echo -e "${WHITE}‚ïë${NC}   ${CYAN}q${NC}       - Sair"
    echo -e "${WHITE}‚ïë${NC}"
    echo -e "${WHITE}‚ïë${NC} ${BOLD}Nos Detalhes:${NC}"
    echo -e "${WHITE}‚ïë${NC}   ${CYAN}b${NC}       - Voltar"
    echo -e "${WHITE}‚ïë${NC}   ${CYAN}d${NC}       - Analisar diret√≥rio"
    echo -e "${WHITE}‚ïë${NC}   ${CYAN}c${NC}       - Limpar cache"
    echo -e "${WHITE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo -e "\n${CYAN}Pressione qualquer tecla para continuar...${NC}"
    read_key > /dev/null
}

# Fun√ß√£o principal
main() {
    # Capturar Ctrl+C
    trap 'restore_terminal; echo -e "\n${GREEN}Saindo...${NC}"; exit 0' INT TERM
    
    clear
    echo -e "${CYAN}  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ïó${NC}"
    echo -e "${CYAN}  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë    ‚ñà‚ñà‚ïë${NC}"
    echo -e "${CYAN}  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë ‚ñà‚ïó ‚ñà‚ñà‚ïë${NC}"
    echo -e "${CYAN}  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ñà‚ñà‚ïó ‚ïö‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë${NC}"
    echo -e "${CYAN}  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïó ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ïî‚ïù${NC}"
    echo -e "${CYAN}  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïù${NC}"
    echo -e "\n${YELLOW}                    ULTRA - Vers√£o 2.1 (Navega√ß√£o Corrigida)${NC}"
    echo -e "${GREEN}                      Carregando interface...${NC}"
    sleep 2
    
    navigate
}

# Executar
main "$@"
